name: Test - Atom Sweep MI355X

concurrency:
  group: atom-benchmark-lock
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      run_1k1k:
        description: 'Run 1k/1k sequence length'
        type: boolean
        default: true
      run_8k1k:
        description: 'Run 8k/1k sequence length'
        type: boolean
        default: false
      run_1k8k:
        description: 'Run 1k/8k sequence length'
        type: boolean
        default: false

jobs:
  bmk-atom-1k1k:
    if: ${{ inputs.run_1k1k }}
    uses: ./.github/workflows/benchmark-tmpl.yml
    secrets: inherit
    with:
      exp-name: 'gptoss'
      isl: '1024'
      osl: '1024'
      max-model-len: '2048'
      random-range-ratio: '0.8'
      runner: mi355x-amd_4
      image: 'rocm/pytorch-private:atom_dev'
      model: 'openai/gpt-oss-120b'
      tp-list: '[1]'
      conc-list: '[4, 8, 16, 32, 64, 128]'
      framework: 'atom'
      precision: 'fp4'

  bmk-atom-8k1k:
    if: ${{ inputs.run_8k1k }}
    uses: ./.github/workflows/benchmark-tmpl.yml
    secrets: inherit
    with:
      exp-name: 'gptoss'
      isl: '8192'
      osl: '1024'
      max-model-len: '16384'
      random-range-ratio: '0.8'
      runner: mi355x-amd_4
      image: 'rocm/pytorch-private:atom_dev'
      model: 'openai/gpt-oss-120b'
      tp-list: '[1]'
      conc-list: '[4, 8, 16, 32, 64, 128]'
      framework: 'atom'
      precision: 'fp4'

  bmk-atom-1k8k:
    if: ${{ inputs.run_1k8k }}
    uses: ./.github/workflows/benchmark-tmpl.yml
    secrets: inherit
    with:
      exp-name: 'gptoss'
      isl: '1024'
      osl: '8192'
      max-model-len: '16384'
      random-range-ratio: '0.8'
      runner: mi355x-amd_4
      image: 'rocm/pytorch-private:atom_dev'
      model: 'openai/gpt-oss-120b'
      tp-list: '[1]'
      conc-list: '[4, 8, 16, 32, 64, 128]'
      framework: 'atom'
      precision: 'fp4'

  collect-results:
    needs: [bmk-atom-1k1k, bmk-atom-8k1k, bmk-atom-1k8k]
    if: ${{ always() }}
    uses: ./.github/workflows/collect-results.yml
    secrets: inherit
    with:
      exp-name: 'gptoss'
